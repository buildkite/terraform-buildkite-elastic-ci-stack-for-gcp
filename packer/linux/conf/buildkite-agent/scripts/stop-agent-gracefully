#!/usr/bin/env bash
set -euo pipefail

# Gracefully stop the Buildkite agent
echo "--- Gracefully stopping Buildkite agent"

# Get the currently running jobs
RUNNING_JOBS=$(buildkite-agent-stable meta-data get "jobs" --default="" 2>/dev/null || echo "")

if [[ -n "$RUNNING_JOBS" ]]; then
  echo "Waiting for running jobs to complete: $RUNNING_JOBS"

  # Wait up to 10 minutes for jobs to complete
  TIMEOUT=600
  ELAPSED=0

  while [[ $ELAPSED -lt $TIMEOUT ]]; do
    if ! pgrep -f "buildkite-agent.*start" > /dev/null; then
      echo "Agent is no longer running, exiting gracefully"
      exit 0
    fi

    sleep 10
    ELAPSED=$((ELAPSED + 10))
    echo "Waiting for jobs to complete... (${ELAPSED}s elapsed)"
  done

  echo "Timeout reached, forcing shutdown"
fi

# Stop the systemd service
echo "Stopping buildkite-agent service"
sudo systemctl stop buildkite-agent || true

echo "Buildkite agent stopped gracefully"
