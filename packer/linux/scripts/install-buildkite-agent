#!/usr/bin/env bash
set -euo pipefail

# Set non-interactive mode for any apt operations
export DEBIAN_FRONTEND=noninteractive
export DEBCONF_NONINTERACTIVE_SEEN=true

echo "Installing Buildkite agent via apt..."

# Install dependencies
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg gettext-base

# Add Buildkite apt repository
echo "Adding Buildkite agent repository..."
curl -fsSL "https://keys.openpgp.org/vks/v1/by-fingerprint/32A37959C2FA5C3C99EFBC32A79206696452D198" \
  | sudo gpg --dearmor -o /usr/share/keyrings/buildkite-agent-archive-keyring.gpg

echo "deb [signed-by=/usr/share/keyrings/buildkite-agent-archive-keyring.gpg] https://apt.buildkite.com/buildkite-agent stable main" \
  | sudo tee /etc/apt/sources.list.d/buildkite-agent.list

sudo apt-get update

# Install buildkite-agent package
echo "Installing buildkite-agent package..."
sudo apt-get install -y buildkite-agent

# Verify installation
buildkite-agent --version

# The apt package creates the buildkite-agent user and directories, but let's ensure
# our expected directory structure exists
echo "Ensuring directory structure..."
sudo mkdir -p /etc/buildkite-agent/hooks
sudo mkdir -p /etc/buildkite-agent/templates
sudo mkdir -p /var/lib/buildkite-agent/builds
sudo mkdir -p /var/lib/buildkite-agent/git-mirrors
sudo mkdir -p /var/lib/buildkite-agent/plugins

# Install configuration templates to persistent location
echo "Installing configuration templates..."
sudo cp /tmp/templates/config/buildkite-agent.cfg.template /etc/buildkite-agent/templates/
sudo cp /tmp/templates/config/buildkite-agent-env.template /etc/buildkite-agent/templates/

# Install bootstrap script
echo "Installing bootstrap script..."
sudo cp /tmp/templates/scripts/bootstrap-buildkite-agent /usr/local/bin/bootstrap-buildkite-agent
sudo chmod +x /usr/local/bin/bootstrap-buildkite-agent

# Set ownership
sudo chown -R buildkite-agent:buildkite-agent /etc/buildkite-agent
sudo chown -R buildkite-agent:buildkite-agent /var/lib/buildkite-agent

# Copy custom hooks if present
echo "Copying custom hooks..."
if [ -d /tmp/conf/buildkite-agent/hooks ]; then
  sudo cp -a /tmp/conf/buildkite-agent/hooks/* /etc/buildkite-agent/hooks/ || echo "No hooks to copy"
  sudo chmod +x /etc/buildkite-agent/hooks/* || true
  sudo chown -R buildkite-agent:buildkite-agent /etc/buildkite-agent/hooks
fi

# Install sudoers config
echo "Adding sudoers config..."
if [ -f /tmp/conf/buildkite-agent/sudoers.conf ]; then
  sudo cp /tmp/conf/buildkite-agent/sudoers.conf /etc/sudoers.d/buildkite-agent
else
  echo "buildkite-agent ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/buildkite-agent
fi
sudo chmod 440 /etc/sudoers.d/buildkite-agent

# Install custom systemd service (overrides the apt package default)
echo "Installing systemd service..."
if [ -f /tmp/conf/buildkite-agent/systemd/buildkite-agent.service ]; then
  sudo cp /tmp/conf/buildkite-agent/systemd/buildkite-agent.service /etc/systemd/system/buildkite-agent.service
fi

# Install termination scripts
echo "Installing termination scripts..."
sudo mkdir -p /usr/local/bin
if [ -f /tmp/conf/buildkite-agent/scripts/stop-agent-gracefully ]; then
  sudo cp /tmp/conf/buildkite-agent/scripts/stop-agent-gracefully /usr/local/bin/stop-agent-gracefully
  sudo chmod +x /usr/local/bin/stop-agent-gracefully
fi

if [ -f /tmp/conf/buildkite-agent/scripts/terminate-instance ]; then
  sudo cp /tmp/conf/buildkite-agent/scripts/terminate-instance /usr/local/bin/terminate-instance
  sudo chmod +x /usr/local/bin/terminate-instance
fi

# Don't enable or start the service - that happens at VM boot via bootstrap
sudo systemctl daemon-reload

echo "Buildkite agent installation complete."
