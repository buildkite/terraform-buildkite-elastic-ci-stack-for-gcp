#!/usr/bin/env bash
set -euo pipefail

# Build script for Buildkite Elastic CI Stack GCP Custom Image
# Version: 0.1.0

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default values
PROJECT_ID=""
ZONE="us-central1-a"
MACHINE_TYPE="e2-standard-4"
ARCH="x86-64"
BUILD_NUMBER="$(date +%Y%m%d-%H%M%S)"
AGENT_VERSION="stable"
SERVICE_ACCOUNT_EMAIL=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    cat << EOF
Usage: $0 [OPTIONS]

Build a custom GCP VM image for Buildkite Elastic CI Stack

OPTIONS:
    -p, --project-id PROJECT_ID    GCP project ID (required)
    -z, --zone ZONE               GCP zone (default: us-central1-a)
    -m, --machine-type TYPE       Machine type for build (default: e2-standard-4)
    -a, --arch ARCH               Architecture: x86-64 or arm64 (default: x86-64)
    -b, --build-number NUMBER     Build number (default: timestamp)
    -v, --agent-version VERSION   Buildkite agent version (default: stable)
    -s, --service-account EMAIL   Service account email for build instance (optional)
    -h, --help                    Show this help message

EXAMPLES:
    $0 --project-id my-gcp-project
    $0 --project-id my-project --zone us-west1-a --arch arm64

REQUIREMENTS:
    - Packer installed and in PATH
    - GCP credentials configured (gcloud auth application-default login)
    - Compute Engine API enabled in the target project
EOF
}

log_info() {
    echo -e "${GREEN}[INFO]${NC} $*"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*"
}

check_requirements() {
    log_info "Checking requirements..."

    # Check if packer is installed
    if ! command -v packer &> /dev/null; then
        log_error "Packer is not installed. Please install Packer and try again."
        log_info "Visit: https://developer.hashicorp.com/packer/tutorials/docker-get-started/get-started-install-cli"
        exit 1
    fi

    # Check if gcloud is installed and authenticated
    if ! command -v gcloud &> /dev/null; then
        log_error "gcloud CLI is not installed. Please install it and try again."
        log_info "Visit: https://cloud.google.com/sdk/docs/install"
        exit 1
    fi

    # Check if authenticated with gcloud
    if ! gcloud auth application-default print-access-token &> /dev/null; then
        log_error "GCP authentication not found."
        log_info "Please run: gcloud auth application-default login"
        exit 1
    fi

    # Check if required directories exist
    if [ ! -d "linux/conf" ]; then
        log_error "Configuration directory 'linux/conf' not found."
        log_error "Make sure you're running this script from the packer directory."
        exit 1
    fi

    if [ ! -d "linux/scripts" ]; then
        log_error "Scripts directory 'linux/scripts' not found."
        log_error "Make sure you're running this script from the packer directory."
        exit 1
    fi

    # Create build and plugins directories if they don't exist
    if [ ! -d "../build" ]; then
        log_info "Creating build directory..."
        mkdir -p ../build
        echo "# Build artifacts will be placed here" > ../build/README.md
    fi

    if [ ! -d "../plugins" ]; then
        log_info "Creating plugins directory..."
        mkdir -p ../plugins
        echo "# Buildkite plugins will be placed here" > ../plugins/README.md
    fi

    log_info "Requirements check passed."
}

validate_project() {
    log_info "Validating GCP project: $PROJECT_ID"

    if ! gcloud projects describe "$PROJECT_ID" &> /dev/null; then
        log_error "Project '$PROJECT_ID' not found or not accessible."
        log_info "Please check the project ID and your permissions."
        exit 1
    fi

    log_info "Project validation passed."
}

check_service_account() {
    if [[ -n "$SERVICE_ACCOUNT_EMAIL" ]]; then
        log_info "Validating service account: $SERVICE_ACCOUNT_EMAIL"
        if ! gcloud iam service-accounts describe "$SERVICE_ACCOUNT_EMAIL" --project="$PROJECT_ID" &> /dev/null; then
            log_error "Service account '$SERVICE_ACCOUNT_EMAIL' not found."
            log_info "Please create the service account or use a different one."
            exit 1
        fi
        log_info "Service account validation passed."
    else
        log_info "No service account specified, checking for default Compute Engine service account..."

        local default_sa="${PROJECT_ID//-/}@${PROJECT_ID}.iam.gserviceaccount.com"
        local compute_sa="$(gcloud projects describe "$PROJECT_ID" --format="value(projectNumber)" 2>/dev/null)-compute@developer.gserviceaccount.com"

        if gcloud iam service-accounts describe "$compute_sa" --project="$PROJECT_ID" &> /dev/null; then
            log_info "Default Compute Engine service account found."
        else
            log_warn "Default Compute Engine service account not found."
            log_info "Creating a service account for Packer builds..."

            local sa_name="packer-builder"
            local sa_email="${sa_name}@${PROJECT_ID}.iam.gserviceaccount.com"

            if ! gcloud iam service-accounts describe "$sa_email" --project="$PROJECT_ID" &> /dev/null; then
                gcloud iam service-accounts create "$sa_name" \
                    --project="$PROJECT_ID" \
                    --display-name="Packer Builder" \
                    --description="Service account for Packer image builds"

                # Grant necessary permissions
                gcloud projects add-iam-policy-binding "$PROJECT_ID" \
                    --member="serviceAccount:$sa_email" \
                    --role="roles/compute.instanceAdmin.v1" \
                    --quiet

                gcloud projects add-iam-policy-binding "$PROJECT_ID" \
                    --member="serviceAccount:$sa_email" \
                    --role="roles/iam.serviceAccountUser" \
                    --quiet

                log_info "Created service account: $sa_email"
            fi

            SERVICE_ACCOUNT_EMAIL="$sa_email"
        fi
    fi
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--project-id)
            PROJECT_ID="$2"
            shift 2
            ;;
        -z|--zone)
            ZONE="$2"
            shift 2
            ;;
        -m|--machine-type)
            MACHINE_TYPE="$2"
            shift 2
            ;;
        -a|--arch)
            ARCH="$2"
            shift 2
            ;;
        -b|--build-number)
            BUILD_NUMBER="$2"
            shift 2
            ;;
        -v|--agent-version)
            AGENT_VERSION="$2"
            shift 2
            ;;
        -s|--service-account)
            SERVICE_ACCOUNT_EMAIL="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
    esac
done

# Check required parameters
if [[ -z "$PROJECT_ID" ]]; then
    log_error "Project ID is required"
    usage
    exit 1
fi

# Validate architecture
if [[ "$ARCH" != "x86-64" && "$ARCH" != "arm64" ]]; then
    log_error "Architecture must be either 'x86-64' or 'arm64'"
    exit 1
fi

log_info "Starting Buildkite Elastic CI Stack GCP image build..."
log_info "Configuration:"
log_info "  Project ID: $PROJECT_ID"
log_info "  Zone: $ZONE"
log_info "  Machine Type: $MACHINE_TYPE"
log_info "  Architecture: $ARCH"
log_info "  Build Number: $BUILD_NUMBER"
log_info "  Agent Version: $AGENT_VERSION"
if [[ -n "$SERVICE_ACCOUNT_EMAIL" ]]; then
    log_info "  Service Account: $SERVICE_ACCOUNT_EMAIL"
else
    log_info "  Service Account: Using default"
fi

check_requirements
validate_project
check_service_account

# Initialize Packer plugins if needed
log_info "Initializing Packer plugins..."
cd "$SCRIPT_DIR/linux"
if [ ! -d ".packer.d" ] || [ ! "$(ls -A .packer.d 2>/dev/null)" ]; then
    packer init buildkite-vm-image.pkr.hcl
    if [[ $? -ne 0 ]]; then
        log_error "Failed to initialize Packer plugins"
        exit 1
    fi
fi
cd "$SCRIPT_DIR"

# Build the image
log_info "Building Packer image..."

cd "$SCRIPT_DIR/linux"
packer build \
    -var "project_id=$PROJECT_ID" \
    -var "zone=$ZONE" \
    -var "machine_type=$MACHINE_TYPE" \
    -var "arch=$ARCH" \
    -var "build_number=$BUILD_NUMBER" \
    -var "agent_version=$AGENT_VERSION" \
    -var "service_account_email=$SERVICE_ACCOUNT_EMAIL" \
    buildkite-vm-image.pkr.hcl

if [[ $? -eq 0 ]]; then
    log_info "Image build completed successfully!"
    log_info "You can now use this image to create Buildkite CI agents in GCP."
    log_info ""
    log_info "Next steps:"
    log_info "1. Create VM instances using the new custom image"
    log_info "2. Configure Buildkite agent token and other settings"
    log_info "3. Start the Buildkite agent service"
else
    log_error "Image build failed. Check the output above for details."
    exit 1
fi
