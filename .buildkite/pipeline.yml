steps:
  - group: ":terraform: Root Modules"
    steps:
      - label: ":terraform: Format Check"
        key: terraform-fmt
        if_changed:
          - "*.tf"
        plugins:
          - docker-compose#v5.12.0:
              config: compose.yml
              run: terraform
              command: ["fmt", "-check", "-recursive"]

      - label: ":terraform: Validate Modules"
        key: terraform-validate-modules
        if_changed:
          - "*.tf"
          - "*.tfvars"
        plugins:
          - docker-compose#v5.12.0:
              config: compose.yml
              run: terraform
              command:
                - sh
                - -c
                - |
                  set -euo pipefail
                  echo "ðŸ” Validating Terraform modules"
                  for dir in modules/*/; do
                    echo "Validating $$dir"
                    cd "$$dir"
                    terraform init -backend=false
                    terraform validate
                    cd - > /dev/null
                  done

      - label: ":lint-roller: TFLint"
        key: tflint
        if_changed:
          - "*.tf"
        plugins:
          - docker-compose#v5.12.0:
              config: compose.yml
              run: tflint
              command: ["--recursive", "--minimum-failure-severity=error"]

      - label: ":shield: TFSec Security Scan"
        key: tfsec
        if_changed:
          - "*.tf"
        plugins:
          - docker-compose#v5.12.0:
              config: compose.yml
              run: tfsec
              command: ["."]

  - group: ":packer: Packer Checks"
    steps:
      - label: ":packer: Format Check"
        key: packer-fmt
        if_changed:
          - "packer/linux/"
        plugins:
          - docker-compose#v5.12.0:
              config: compose.yml
              run: packer
              command: ["fmt", "-check", "packer/linux/"]

      - label: ":packer: Validate"
        key: packer-validate
        if_changed:
          - "packer/linux/"
        plugins:
          - docker-compose#v5.12.0:
              config: compose.yml
              run: packer
              command:
                - sh
                - -c
                - |
                  set -euo pipefail
                  echo "ðŸ” Validating Packer template"
                  packer validate -var project_id=test-project packer/linux/buildkite-vm-image.pkr.hcl

      - label: ":bash: ShellCheck"
        key: shellcheck
        plugins:
          - docker-compose#v5.12.0:
              config: compose.yml
              run: shellcheck
              command:
                - sh
                - -c
                - |
                  set -euo pipefail
                  echo "ðŸ§¹ Linting shell scripts"

                  # Check packer scripts
                  echo "Checking packer scripts..."
                  shellcheck packer/linux/scripts/*

                  # Check template scripts
                  echo "Checking template scripts..."
                  shellcheck templates/scripts/*

                  # Check packer bootstrap and build scripts
                  echo "Checking packer bootstrap and build..."
                  shellcheck packer/bootstrap packer/build

                  # Check startup script template (ignore template variables)
                  echo "Checking startup script template..."
                  shellcheck -e SC2154 modules/compute/templates/startup.sh

  - group: "ðŸ“– Docs and Examples"
    steps:
      - label: ":terraform: Validate Examples"
        key: terraform-validate-examples
        if_changed:
          - "examples/*"
        plugins:
          - docker-compose#v5.12.0:
              config: compose.yml
              run: terraform
              command:
                - sh
                - -c
                - |
                  set -euo pipefail
                  echo "ðŸ” Validating Terraform examples"
                  for dir in examples/*/; do
                    echo "Validating $$dir"
                    cd "$$dir"
                    terraform init -backend=false
                    terraform validate
                    cd - > /dev/null
                  done

      - label: ":markdown: Markdown Lint"
        key: markdownlint
        if_changed:
          - "*.md"
        plugins:
          - docker-compose#v5.12.0:
              config: compose.yml
              run: markdownlint
              command: ["**/*.md"]
