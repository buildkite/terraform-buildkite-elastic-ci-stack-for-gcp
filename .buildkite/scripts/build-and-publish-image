#!/usr/bin/env bash
set -euo pipefail

# Build and publish a GCP VM image
# Usage: ./build-and-publish-image <arch>

ARCH="${1:-x86-64}"
PROJECT_ID="${GCP_PROJECT_ID:-buildkite-gcp-stack}"
BUILD_ZONE="${GCP_BUILD_ZONE:-us-central1-a}"
BUILD_NUMBER="${BUILDKITE_BUILD_NUMBER:-local}"
COMMIT="${BUILDKITE_COMMIT:-unknown}"
SERVICE_ACCOUNT="${GCP_PACKER_SERVICE_ACCOUNT:-gcp-image-builder-ci@${PROJECT_ID}.iam.gserviceaccount.com}"

echo "--- :hammer: Building ${ARCH} image"
echo "Project: ${PROJECT_ID}"
echo "Zone: ${BUILD_ZONE}"
echo "Build: ${BUILD_NUMBER}-${COMMIT:0:7}"
echo "Service Account: ${SERVICE_ACCOUNT}"

# Change to packer directory and run build
cd packer
./build \
  --project-id "$PROJECT_ID" \
  --arch "$ARCH" \
  --build-number "${BUILD_NUMBER}-${COMMIT:0:7}" \
  --zone "$BUILD_ZONE" \
  --service-account "$SERVICE_ACCOUNT"

echo "--- :earth_americas: Making image public"

# Get the image name from Packer's manifest file
MANIFEST_FILE="linux/manifest.json"
if [[ ! -f "$MANIFEST_FILE" ]]; then
  echo "Error: Packer manifest file not found at $MANIFEST_FILE"
  exit 1
fi

# Extract image name from manifest (jq parses the JSON output from Packer)
IMAGE_NAME=$(jq -r '.builds[-1].artifact_id' "$MANIFEST_FILE")

if [[ -z "$IMAGE_NAME" || "$IMAGE_NAME" == "null" ]]; then
  echo "Error: Could not extract image name from manifest"
  echo "Manifest contents:"
  cat "$MANIFEST_FILE"
  exit 1
fi

echo "Found image: $IMAGE_NAME"

# Make the image public
echo "Granting public access to $IMAGE_NAME"
gcloud compute images add-iam-policy-binding "$IMAGE_NAME" \
  --project="$PROJECT_ID" \
  --member="allAuthenticatedUsers" \
  --role="roles/compute.imageUser"

# Add image to family for easy reference
echo "Adding image to family buildkite-ci-stack-${ARCH}"
gcloud compute images update "$IMAGE_NAME" \
  --project="$PROJECT_ID" \
  --family="buildkite-ci-stack-${ARCH}"

# Export image name for later steps
echo "Exporting image name for downstream steps"
mkdir -p .buildkite
echo "$IMAGE_NAME" > ".buildkite/${ARCH}-image-name.txt"

# Set buildkite metadata if running in Buildkite
if [[ -n "${BUILDKITE:-}" ]]; then
  buildkite-agent meta-data set "${ARCH}-image-name" "$IMAGE_NAME"
fi

echo "--- :white_check_mark: Successfully built and published ${ARCH} image: $IMAGE_NAME"
